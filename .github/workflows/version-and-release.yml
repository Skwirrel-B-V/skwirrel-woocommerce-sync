name: Version, Tag & Release

on:
  push:
    branches:
      - '**'

# Prevent recursive triggers when the workflow commits back
permissions:
  contents: write

jobs:
  version-and-release:
    # Skip if the commit was made by this workflow
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine new version
        id: version
        run: |
          # Get the latest tag (any branch), default to v1.0.0 if none
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v1.0.0"
          fi

          echo "Latest tag: $LATEST_TAG"

          # Parse major.minor.patch
          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Determine branch
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH"

          if [ "$BRANCH" = "main" ]; then
            # Main branch: bump minor, reset patch
            MINOR=$((MINOR + 1))
            PATCH=0
            PRERELEASE=""
          else
            # Feature branch: bump patch
            PATCH=$((PATCH + 1))
            # Create a safe suffix from the branch name
            SAFE_BRANCH=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9]/-/g' | cut -c1-40)
            PRERELEASE=""
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          TAG="v${NEW_VERSION}"

          # Ensure this tag doesn't already exist; if it does, keep incrementing patch
          while git rev-parse "$TAG" >/dev/null 2>&1; do
            PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            TAG="v${NEW_VERSION}"
          done

          echo "New version: $NEW_VERSION"
          echo "Tag: $TAG"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="${{ steps.version.outputs.branch }}"

          # Check if the latest tag actually exists as a git object
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            RANGE="${LATEST_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi

          # Build changelog from commit messages
          CHANGES=$(git log "$RANGE" --pretty=format:"- %s (%h)" --no-merges 2>/dev/null || echo "- Initial release")

          if [ -z "$CHANGES" ]; then
            CHANGES="- No notable changes"
          fi

          # Build release body
          DATE=$(date +%Y-%m-%d)
          {
            echo "body<<CHANGELOG_EOF"
            echo "## What's Changed"
            echo ""
            echo "$CHANGES"
            echo ""
            echo "**Branch:** \`$BRANCH\`"
            echo "**Full Changelog:** https://github.com/${{ github.repository }}/compare/${LATEST_TAG}...${TAG}"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

          # Build CHANGELOG.md entry
          CHANGELOG_ENTRY="## [${VERSION}] - ${DATE}

${CHANGES}
"
          # Save for next step
          echo "$CHANGELOG_ENTRY" > /tmp/changelog_entry.md

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to Skwirrel WooCommerce Sync will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Insert new entry after the header lines (after line 3)
          {
            head -n 3 CHANGELOG.md
            echo ""
            cat /tmp/changelog_entry.md
            tail -n +4 CHANGELOG.md
          } > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

      - name: Update plugin version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PLUGIN_FILE="skwirrel-woocommerce-sync.php"

          # Update plugin header version
          sed -i "s/^ \* Version: .*/ * Version: ${VERSION}/" "$PLUGIN_FILE"

          # Update version constant
          sed -i "s/define('SKWIRREL_WC_SYNC_VERSION', '.*');/define('SKWIRREL_WC_SYNC_VERSION', '${VERSION}');/" "$PLUGIN_FILE"

      - name: Commit version changes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          git add CHANGELOG.md skwirrel-woocommerce-sync.php
          git commit -m "chore: release ${VERSION} [skip ci]" || echo "No changes to commit"
          git tag -a "$TAG" -m "Release ${VERSION}"
          git push origin HEAD
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          body: ${{ steps.changelog.outputs.body }}
          prerelease: ${{ steps.version.outputs.branch != 'main' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
